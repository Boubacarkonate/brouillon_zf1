<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
    .pagination-sticky {
        position: sticky;
        bottom: 0;
        background-color: white;
        padding: 0.5rem 0;
        z-index: 10;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    }

    .col-md-3 .overflow-auto {
        padding-bottom: 70px;
    }

    .blocpopover {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-height: 80vh;
        width: 60%;
        background-color: white;
        z-index: 1050;
        border-radius: 0.5rem;
        overflow-y: auto;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        display: none;
        padding: 1rem;
    }

    #popover-background {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1040;
        display: none;
    }

    .blocpopover .popover-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #6c757d;
        color: white;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .blocpopover .nav-tabs {
        margin-bottom: 1rem;
    }
</style>

<!-- Filtres modernes -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
        <form method="get" class="d-flex flex-nowrap align-items-end gap-3 overflow-auto">
            <div style="min-width:180px;">
                <label class="form-label text-muted">Code commune (INSEE)</label>
                <input type="text" name="code_commune" class="form-control shadow-sm"
                    value="<?= $this->escape($this->codeCommune) ?>" placeholder="Ex : 75120">
            </div>


            <div style="min-width:180px;">
                <label class="form-label text-muted">Thématique</label>
                <select name="theme" class="form-select shadow-sm">
                    <option value="">Toutes thématiques</option>
                    <?php foreach ($this->thematique as $value => $label): ?>
                        <option value="<?= $this->escape($value) ?>" <?= ($this->themeValue == $value ? 'selected' : '') ?>>
                            <?= $this->escape($label) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>




            <div style="min-width:180px;">
                <label class="form-label text-muted">Type</label>
                <select name="type" class="form-select shadow-sm">
                    <option value="">Tous types</option>
                    <?php foreach ($this->allTypes as $value => $label): ?>
                        <option value="<?= $this->escape($value) ?>" <?= ($this->typeValue == $value ? 'selected' : '') ?>>
                            <?= $this->escape($label) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div style="min-width:180px;">
                <label class="form-label text-muted">Source</label>
                <select name="source" class="form-select shadow-sm">
                    <option value="">Toutes sources</option>
                    <?php foreach ($this->sources as $id => $label): ?>
                        <option value="<?= $this->escape($id) ?>" <?= ($this->source == $id ? 'selected' : '') ?>>
                            <?= $this->escape($label) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div style="min-width:220px;">
                <label class="form-label text-muted">Mot-clé</label>
                <input type="text" name="q" class="form-control shadow-sm" value="<?= $this->escape($this->q) ?>">
            </div>

            <div class="d-grid" style="min-width:150px;">
                <button type="submit" class="btn btn-secondary shadow-sm">
                    <i class="bi bi-funnel"></i> Rechercher
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- Liste services -->
    <div class="col-md-3 position-relative" style="max-height:80vh;">
        <?php if (!empty($this->services)): ?>
            <div class="d-flex flex-column gap-3 overflow-auto" style="max-height:80vh;">
                <?php foreach ($this->services as $idx => $s):
                    $desc = $s['description'] ?? '';
                    $descTronquee = strlen($desc) > 120 ? substr($desc, 0, 120) . '...' : $desc;
                ?>
                    <div class="card shadow-sm" data-service-idx="<?= $idx ?>">
                        <div class="card-body d-flex justify-content-between">
                            <div>
                                <h5 class="card-title text-primary"><?= $this->escape($s['label'] ?? '') ?></h5>
                                <p class="card-text small text-muted"><?= $this->escape($descTronquee) ?>
                                    <?php if (strlen($desc) > 120): ?>
                                        <button type="button" class="btn btn-link btn-sm p-0 lire-suite-btn"
                                            data-service-idx="<?= $idx ?>">Lire la suite</button>
                                    <?php endif; ?>
                                </p>
                                <div>
                                    <?php foreach ($s['modes_accueil'] as $key) : ?>
                                        <p><?= $key ?></p>
                                    <?php endforeach ?>

                                </div>
                                <p><?= $s['distance'] ?></p>
                                <p><?= $s['structure']['code_postal'] ?></p>
                                <p><?= $s['structure']['commune'] ?></p>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <?php if (!empty($s['theme'])): ?>
                                        <?php foreach ($s['theme'] as $t): ?>
                                            <span class="badge bg-secondary"><?= $this->escape($t) ?></span>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                    <?php if (!empty($s['type'])): ?>
                                        <span class="badge bg-success"><?= $this->escape($s['type']) ?></span>
                                    <?php endif; ?>
                                    <?php if (!empty($s['source'])): ?>
                                        <span class="badge bg-info"><?= $this->escape($s['source']) ?></span>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>

                        <!-- Popover détails -->
                        <div id="customPopover-<?= $idx ?>" class="blocpopover">
                            <div class="popover-header">
                                <span>Détails du service</span>
                                <button type="button" class="btn-close btn-close-white fermer-popover"></button>
                            </div>
                            <div class="p-3">
                                <ul class="nav nav-tabs" id="serviceTabs-<?= $idx ?>" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" data-bs-toggle="tab"
                                            data-bs-target="#infos-<?= $idx ?>">Infos</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" data-bs-toggle="tab"
                                            data-bs-target="#desc-<?= $idx ?>">Description</button>
                                    </li>
                                </ul>

                                <div class="tab-content border p-3">
                                    <div class="tab-pane fade show active" id="infos-<?= $idx ?>">
                                        <h5 class="text-primary"><?= $this->escape($s['label'] ?? '') ?></h5>
                                        <p><strong>Adresse :</strong> <?= $this->escape($s['adresse'] ?? 'N/A') ?></p>
                                        <p><strong>Commune :</strong> <?= $this->escape($s['commune'] ?? 'N/A') ?></p>
                                        <p><strong>Téléphone :</strong> <?= $this->escape($s['telephone'] ?? 'N/A') ?></p>
                                        <p><strong>Courriel :</strong> <?= $this->escape($s['courriel'] ?? 'N/A') ?></p>
                                    </div>
                                    <div class="tab-pane fade" id="desc-<?= $idx ?>">
                                        <p><?= nl2br($this->escape($s['description'] ?? 'Pas de description')) ?></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Bouton Voir sur la carte -->
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary voir-carte-btn"
                                data-service-idx="<?= $idx ?>">
                                Voir sur la carte
                            </button>
                        </div>

                    </div>
                <?php endforeach; ?>
            </div>
        <?php else: ?>
            <div class="alert alert-info">Aucun service trouvé</div>
        <?php endif; ?>
    </div>

    <!-- Carte -->
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div id="map" class="border rounded" style="height:80vh;"></div>
            </div>
        </div>
    </div>
</div>

<div id="popover-background"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const servicesData = <?= json_encode($this->services, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) ?>;
        console.log(servicesData);

        // Initialisation de la carte
        const map = L.map("map").setView([48.8566, 2.3522], 11);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        const markers = L.markerClusterGroup();
        const markerMap = {};

        servicesData.forEach((s, idx) => {
            // Priorité : coordonnées du service > coordonnées de la structure
            const lat = s.lat ?? s.structure?.lat ?? null;
            const lon = s.lon ?? s.structure?.lon ?? null;

            if (lat && lon) {
                const marker = L.marker([lat, lon])
                    .bindPopup(`
                    <strong>${s.label || ''}</strong><br>
                    ${s.adresse || s.structure?.address || ''}
                    <br>${s.structure?.commune || ''}
                `);
                markers.addLayer(marker);
                markerMap[idx] = marker;
            }
        });

        map.addLayer(markers);

        if (markers.getLayers().length) {
            map.fitBounds(markers.getBounds());
        }

        // Bouton "Voir sur la carte"
        document.querySelectorAll('.voir-carte-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = btn.dataset.serviceIdx;
                const marker = markerMap[idx];
                if (marker) {
                    map.setView(marker.getLatLng(), 15, {
                        animate: true
                    }); // centre la carte
                    marker.openPopup(); // ouvre le popup du marker
                }
            });
        });

        // Popover "Lire la suite"
        const bg = document.getElementById('popover-background');
        document.querySelectorAll('.lire-suite-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = btn.dataset.serviceIdx;
                const popover = document.getElementById(`customPopover-${idx}`);
                if (popover) {
                    popover.style.display = 'block';
                    bg.style.display = 'block';
                }
            });
        });

        document.querySelectorAll('.fermer-popover').forEach(btn => {
            btn.addEventListener('click', () => {
                const popover = btn.closest('.blocpopover');
                if (popover) popover.style.display = 'none';
                bg.style.display = 'none';
            });
        });

        bg.addEventListener('click', () => {
            document.querySelectorAll('.blocpopover').forEach(p => p.style.display = 'none');
            bg.style.display = 'none';
        });
    });
</script>