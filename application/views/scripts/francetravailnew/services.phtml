<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<h1>Services d'accompagnement</h1>

<div class="card mb-3">
    <div class="card-body">
        <form id="searchForm" method="get" class="d-flex gap-2 flex-wrap">
            <input name="commune" placeholder="Commune" value="<?= $this->escape($this->commune) ?>" />
            <input name="theme" placeholder="Thématique" value="<?= $this->escape($this->theme) ?>" />
            <input name="type" placeholder="Type" value="<?= $this->escape($this->type) ?>" />
            <select name="source">
                <option value="">Toutes sources</option>
                <?php foreach ($this->sources as $id => $label): ?>
                    <option value="<?= $this->escape($id) ?>" <?= ($this->source == $id ? 'selected' : '') ?>>
                        <?= $this->escape($label) ?>
                    </option>
                <?php endforeach; ?>
            </select>
            <input name="q" placeholder="Mot-clé" value="<?= $this->escape($this->q) ?>" />
            <button class="btn btn-primary">Filtrer</button>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div>Résultats : <?= (int)$this->total ?></div>
        <div id="list" style="max-height:75vh; overflow:auto;">
            <?php if (empty($this->services)): ?>
                <div class="alert alert-info">Aucun service trouvé</div>
            <?php else: ?>
                <?php foreach ($this->services as $s): ?>
                    <div class="card mb-2">
                        <div class="card-body">
                            <h5 class="card-title"><?= $this->escape($s['nom'] ?? 'Sans nom') ?></h5>

                            <?php if (!empty($s['thematiques'])): ?>
                                <div class="mb-1">
                                    <?php foreach ($s['thematiques'] as $t): ?>
                                        <span class="badge bg-secondary"><?= $this->escape($t) ?></span>
                                    <?php endforeach; ?>
                                </div>
                            <?php endif; ?>

                            <?php if (!empty($s['type'])): ?>
                                <div class="small text-muted mb-1">Type : <?= $this->escape($s['type']) ?></div>
                            <?php endif; ?>

                            <?php if (!empty($s['source'])): ?>
                                <div class="small text-muted mb-1">Source : <?= $this->escape($s['source']) ?></div>
                            <?php endif; ?>

                            <?php if (!empty($s['adresse'])): ?>
                                <div class="small"><?= $this->escape($s['adresse']) ?></div>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>
    </div>

    <div class="col-md-8">
        <div id="map" style="height:80vh;"></div>
    </div>
</div>

<script>
    (function() {
        // On mappe les services pour uniformiser les clés
        const services = <?= json_encode($this->services, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) ?>;
        const mappedServices = services.map(s => ({
            label: s.nom,
            address: s.adresse,
            lat: s.lat,
            lon: s.lon
        }));

        const map = L.map('map').setView([48.8566, 2.3522], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const markers = L.markerClusterGroup();
        mappedServices.forEach(s => {
            if (s.lat && s.lon) {
                const marker = L.marker([s.lat, s.lon])
                    .bindPopup(`<strong>${s.label}</strong><br>${s.address}`);
                markers.addLayer(marker);
            }
        });

        map.addLayer(markers);

        if (markers.getLayers().length) {
            map.fitBounds(markers.getBounds(), {
                padding: [50, 50]
            });
        }
    })();
</script>