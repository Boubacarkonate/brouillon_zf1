<script src="https://francetravail.io/data/widget/pe-offres-emploi.js"></script>

<!-- Sélecteur de commune -->
<select id="communes">
    <option value="">-- Choisir une commune --</option>
</select>

<!-- Widget France Travail -->
<pe-offres-emploi></pe-offres-emploi>

<script>
    // Sélection du widget
    var macarte = document.querySelector('pe-offres-emploi');
    macarte.options = {
        theme: "light",
        display: "list"
    };
    macarte.token = "<?php echo $this->francetravailToken; ?>";

    // Charger les communes via l’action communesAction
    fetch("<?php echo $this->url(array('controller' => 'francetravailnew', 'action' => 'communes')); ?>")
        .then(res => res.json())
        .then(communes => {
            const select = document.getElementById("communes");
            communes.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.code; // code INSEE
                opt.textContent = `${c.libelle} (${c.codePostal})`;
                select.appendChild(opt);
            });

            // Quand l'utilisateur choisit une commune
            select.addEventListener("change", function() {
                const codeCommune = this.value;
                if (codeCommune) {
                    macarte.options = {
                        ...macarte.options,
                        commune: codeCommune
                    };
                }
            });
        });
</script>