<h1 class="mb-4 text-primary fw-bold">ðŸ’¼ Recherche d'entreprises - La Bonne Boite</h1>
<!-- Filtres modernisÃ©s -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-light fw-bold text-primary">
        <i class="bi bi-funnel-fill"></i> Filtres de recherche
    </div>
    <div class="card-body">
        <form method="get" class="d-flex flex-nowrap align-items-end gap-3 overflow-auto">

            <div style="min-width:220px;">
                <label class="form-label text-muted">Ville / Code postal</label>
                <input type="text" name="citycode" id="citycode" class="form-control"
                    value="<?= $this->escape($this->citycode ?? '') ?>" required>
            </div>

            <div style="min-width:220px;">
                <label class="form-label text-muted">Code ROME</label>
                <input type="text" name="rome" id="rome" class="form-control"
                    value="<?= $this->escape($this->rome ?? '') ?>" required>
            </div>

            <div style="min-width:180px;">
                <label class="form-label text-muted">Distance (km)</label>
                <input type="number" name="distance" class="form-control" value="<?= (int)($this->distance ?? 10) ?>"
                    min="1" max="100">
            </div>

            <div class="d-grid" style="min-width:150px;">
                <button type="submit" class="btn btn-primary shadow-sm">
                    <i class="bi bi-funnel"></i> Rechercher
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- Liste entreprises -->
    <div class="col-md-3">
        <?php if (!empty($this->resultats['items'])): ?>
        <div class="d-flex flex-column gap-3 overflow-auto" style="max-height:80vh;">
            <?php foreach ($this->resultats['items'] as $idx => $entreprise): ?>
            <div class="card shadow-sm" data-entreprise-idx="<?= $idx ?>">
                <div class="card-body">
                    <h5 class="card-title text-primary"><?= $this->escape($entreprise['company_name'] ?? '') ?></h5>
                    <p class="small text-muted mb-1">
                        <?= $this->escape(($entreprise['naf_label'] ?? '') . ' (' . ($entreprise['naf'] ?? '') . ')') ?>
                    </p>
                    <p class="small text-muted mb-1">
                        <?= $this->escape($entreprise['city'] ?? '') ?>
                        (<?= $this->escape($entreprise['postcode'] ?? '') ?>)
                    </p>
                    <p class="small text-muted mb-1">
                        Effectif:
                        <?= ($entreprise['headcount_min'] ?? '') . ' - ' . ($entreprise['headcount_max'] ?? '') ?><br>
                        Score d'embauche:
                        <?= isset($entreprise['hiring_potential']) ? round($entreprise['hiring_potential'], 1) . '%' : '' ?><br>
                        Haut potentiel: <?= !empty($entreprise['is_high_potential']) ? 'Oui' : 'Non' ?>
                    </p>
                    <p>Siret : <?= $entreprise['siret'] ?></p>
                    <p class="small text-muted mb-1">
                        <?= $this->escape($entreprise['adresse_complete'] ?? '') ?>
                    </p>


                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-primary btn-voir-carte" data-idx="<?= $idx ?>"
                            <?= empty($entreprise['location']['lat']) ? 'disabled title="Localisation indisponible"' : '' ?>>
                            Voir sur la carte
                        </button>
                        <a href="export_csv.php?siret=<?= urlencode($entreprise['siret']) ?>"
                            class="btn btn-sm btn-success">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
                        </a>
                    </div>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
        <?php else: ?>
        <div class="alert alert-info">Aucune entreprise trouvÃ©e.</div>
        <?php endif; ?>
    </div>

    <!-- Carte -->
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div id="map" class="border rounded" style="height:80vh;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet & MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const entreprises =
        <?= json_encode($this->resultats['items'] ?? [], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) ?>;
    const map = L.map('map').setView([<?= $this->latitude ?? 48.8566 ?>, <?= $this->longitude ?? 2.3522 ?>],
        12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup();
    const markerMap = {};

    entreprises.forEach((e, idx) => {
        const lat = e.location?.lat;
        const lon = e.location?.lon;
        if (lat && lon) {
            const marker = L.marker([lat, lon]).bindPopup(`
                <strong>${e.company_name || ''}</strong><br>
                ${e.city || ''} (${e.postcode || ''})<br>
                ${e.naf_label || ''} (${e.naf || ''})<br>
                Effectif: ${e.headcount_min || ''}-${e.headcount_max || ''}<br>
                Score: ${e.hiring_potential ? e.hiring_potential.toFixed(1)+'%' : ''}<br>
                Haut potentiel: ${e.is_high_potential ? 'Oui' : 'Non'}<br>
                NumÃ©ro Siret : ${e.siret}
            `);
            markers.addLayer(marker);
            markerMap[idx] = marker;
        }
    });

    map.addLayer(markers);
    if (markers.getLayers().length) map.fitBounds(markers.getBounds());

    // Boutons "Voir sur la carte"
    document.querySelectorAll('.btn-voir-carte').forEach(btn => {
        btn.addEventListener('click', () => {
            const idx = btn.dataset.idx;
            const marker = markerMap[idx];
            if (!marker) return;
            markers.zoomToShowLayer(marker, () => {
                marker.openPopup();
            });
        });
    });
});
</script>