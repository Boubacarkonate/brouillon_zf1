<h1>Fiche M√©tier</h1>

<?php if (!empty($this->ficheMetier)) : ?>
    <h2>M√©tier : <?= htmlspecialchars($this->ficheMetier['metier']['libelle'] ?? '-') ?></h2>
    <button type="button" class="btn btn-outline-secondary btn-sm btn-enregistrer" title="Enregistrer le m√©tier"
        data-libelle="<?= htmlspecialchars($this->ficheMetier['metier']['libelle'] ?? '') ?>" data-module="fiche">
        enregistrer
    </button>

    <h3>Comp√©tences mobilis√©es :</h3>
    <ul>
        <?php if (!empty($this->ficheMetier['groupesCompetencesMobilisees'])) :
            foreach ($this->ficheMetier['groupesCompetencesMobilisees'] as $groupe) : ?>
                <li><strong>Enjeu :</strong> <?= htmlspecialchars($groupe['enjeu']['libelle'] ?? '-') ?></li>
                <?php if (!empty($groupe['competences'])) :
                    foreach ($groupe['competences'] as $comp) : ?>
                        <li>
                            <?= htmlspecialchars($comp['libelle']) ?>
                            (<?= htmlspecialchars($comp['code']) ?>)
                        </li>
                <?php endforeach;
                endif; ?>
            <?php endforeach;
        else : ?>
            <li>-</li>
        <?php endif; ?>
    </ul>

    <h3>Savoirs :</h3>
    <ul>
        <?php if (!empty($this->ficheMetier['groupesSavoirs'])) :
            foreach ($this->ficheMetier['groupesSavoirs'] as $groupe) :
                if (!empty($groupe['savoirs'])) :
                    foreach ($groupe['savoirs'] as $savoir) : ?>
                        <li>
                            <?= htmlspecialchars($savoir['libelle']) ?>
                            (<?= htmlspecialchars($savoir['code']) ?>)
                        </li>
            <?php endforeach;
                endif;
            endforeach;
        else : ?>
            <li>-</li>
        <?php endif; ?>
    </ul>
<?php else : ?>
    <p>Aucune donn√©e disponible.</p>
<?php endif; ?>

<script>
    $(document).ready(function() {
        $(document).on('click', '.btn-enregistrer', function() {
            const btn = $(this);

            // R√©cup√©ration des donn√©es du bouton
            const fiche = {
                libelle: btn.data('libelle'),
                url: window.location.href, // üëà r√©cup√®re l'URL compl√®te de la page
                module: btn.data('module')
            };

            console.log("üì¶ Donn√©es envoy√©es :", fiche);

            $.ajax({
                url: '/zf1/public/francetravailnew/enregistreroffre',
                method: 'POST',
                dataType: 'json',
                data: fiche,
                success: function(res) {
                    if (res.success) {
                        alert("‚úÖ Fiche m√©tier enregistr√©e !");
                    } else {
                        alert("‚ùå Erreur : " + (res.message ||
                            "Impossible d'enregistrer la fiche."));
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erreur AJAX :", status, error, xhr.responseText);
                    alert("‚ö†Ô∏è Erreur r√©seau (" + status + ")");
                }
            });
        });
    });
</script>