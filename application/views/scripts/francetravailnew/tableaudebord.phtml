<div class="container-fluid py-3">

    <!-- ===== Boutons indicateurs ===== -->
    <div class="row g-3 mb-4">
        <button class="col-md-3 btn btn-primary btn-filter" data-type="offres">
            <div class="card shadow-sm border-0 p-3 text-center">
                <div class="d-flex align-items-center justify-content-center mb-1">
                    <iconify-icon icon="mdi:file-document-outline" width="18" height="18" class="me-2"></iconify-icon>
                    <span class="text-muted">Offres enregistrées</span>
                </div>
                <h4 class="fw-bold text-primary mb-0"><?= $this->totalOffreData ?? 0 ?></h4>
            </div>
        </button>

        <button class="col-md-3 btn btn-primary btn-filter" data-type="metiers">
            <div class="card shadow-sm border-0 p-3 text-center">
                <div class="d-flex align-items-center justify-content-center mb-1">
                    <iconify-icon icon="mdi:cog-outline" width="18" height="18" class="me-2"></iconify-icon>
                    <span class="text-muted">Métiers détectés</span>
                </div>
                <h4 class="fw-bold text-primary mb-0"><?= $this->totalMetiersData ?? 0 ?></h4>
            </div>
        </button>

        <button class="col-md-3 btn btn-primary btn-filter" data-type="services">
            <div class="card shadow-sm border-0 p-3 text-center">
                <div class="d-flex align-items-center justify-content-center mb-1">
                    <iconify-icon icon="mdi:handshake-outline" width="18" height="18" class="me-2"></iconify-icon>
                    <span class="text-muted">Services proches</span>
                </div>
                <h4 class="fw-bold text-primary mb-0"><?= $this->totalServicesData ?? 0 ?></h4>
            </div>
        </button>

        <button class="col-md-3 btn btn-primary btn-filter" data-type="entreprises">
            <div class="card shadow-sm border-0 p-3 text-center">
                <div class="d-flex align-items-center justify-content-center mb-1">
                    <iconify-icon icon="mdi:domain" width="18" height="18" class="me-2"></iconify-icon>
                    <span class="text-muted">Entreprises</span>
                </div>
                <h4 class="fw-bold text-primary mb-0"><?= $this->totalEntreprisesData ?? 0 ?></h4>
            </div>
        </button>
    </div>

    <div class="row">
        <!-- ===== COL GAUCHE : affichage dynamique ===== -->
        <div class="col-md-4">
            <div id="left-panel" class="list-group list-group-flush" style="max-height: 70vh; overflow-y: auto;">
                <div class="text-muted">Cliquez sur un bouton ci-dessus pour voir les données.</div>
            </div>
        </div>

        <!-- ===== CENTRE : CARTE ===== -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3">
                <div id="master-map" class="border w-100" style="height:40vh;"></div>
            </div>
        </div>

        <!-- ===== DROITE : Projets & Liens ===== -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3 mb-3">
                <h5 class="fw-semibold text-secondary mb-3 d-flex align-items-center">
                    <iconify-icon icon="mdi:folder-open" width="20" height="20" class="me-1"></iconify-icon>Projets
                </h5>
                <ul class="list-unstyled mb-0">
                    <?php for ($i = 1; $i <= 4; $i++): ?>
                        <?php $p = "Projet $i"; ?>
                        <li>
                            <a href="?projet=<?= $p ?>"
                                class="btn <?= ($this->currentProjet === $p) ? 'btn-primary' : 'btn-outline-primary' ?> mb-1">
                                <?= $p ?> — <em>Métier - Code ROME</em>
                            </a>
                        </li>
                    <?php endfor; ?>
                </ul>
            </div>

            <div class="card shadow-sm border-0 p-3">
                <h5 class="fw-semibold text-secondary mb-3 d-flex align-items-center">
                    <iconify-icon icon="mdi:link-variant" width="20" height="20" class="me-1"></iconify-icon>Liens
                </h5>
                <ul class="nav flex-column">
                    <li class="nav-item mb-1">
                        <a class="nav-link text-primary px-0 d-flex align-items-center"
                            href="<?= $this->url(['controller' => 'francetravail', 'action' => 'offreemploi']); ?>"
                            target="_blank">
                            <iconify-icon icon="mdi:briefcase-outline" width="16" height="16" class="me-1">
                            </iconify-icon>
                            Offres d’emploi
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a class="nav-link text-primary px-0 d-flex align-items-center"
                            href="<?= $this->url(['controller' => 'francetravail', 'action' => 'metiercompetence']); ?>"
                            target="_blank">
                            <iconify-icon icon="mdi:lightbulb-outline" width="16" height="16" class="me-1">
                            </iconify-icon>
                            Métiers & Compétences
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a class="nav-link text-primary px-0 d-flex align-items-center"
                            href="<?= $this->url(['controller' => 'francetravail', 'action' => 'metiercompetence']); ?>"
                            target="_blank">
                            <iconify-icon icon="mdi:office-building" width="16" height="16" class="me-1"></iconify-icon>
                            Entreprises & Recrutement
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a class="nav-link text-primary px-0 d-flex align-items-center"
                            href="<?= $this->url(['controller' => 'francetravail', 'action' => 'marchetravaillocal']); ?>"
                            target="_blank">
                            <iconify-icon icon="mdi:chart-line" width="16" height="16" class="me-1"></iconify-icon>
                            Marché du travail local
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a class="nav-link text-primary px-0 d-flex align-items-center"
                            href="<?= $this->url(['controller' => 'francetravail', 'action' => 'serviceaccompagnement']); ?>"
                            target="_blank">
                            <iconify-icon icon="mdi:account-group-outline" width="16" height="16" class="me-1">
                            </iconify-icon>
                            Services d’accompagnement
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- ===== Leaflet CSS & JS ===== -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://code.iconify.design/iconify-icon/2.0.0/iconify-icon.min.js"></script>

<!-- ===== Script Filtrage & Leaflet ===== -->

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const data = {
            offres: <?= json_encode($this->offresData ?? []) ?>,
            metiers: <?= json_encode($this->metiersData ?? []) ?>,
            services: <?= json_encode($this->servicesData ?? []) ?>,
            entreprises: <?= json_encode($this->entreprisesData ?? []) ?>
        };

        const leftPanel = document.getElementById('left-panel');

        function renderData(type) {
            leftPanel.innerHTML = '';
            const items = data[type] || [];
            if (!items.length) {
                leftPanel.innerHTML = `<div class="text-muted">Aucune donnée disponible pour ${type}.</div>`;
                return;
            }
            items.forEach((item, idx) => {
                let coords = item.latitude && item.longitude ?
                    ` (lat: ${item.latitude}, lon: ${item.longitude})` : '';
                let url = item.url ? `<a href="${item.url}" target="_blank">Voir</a>` : '';
                let html = `<div class="list-group-item border-0 border-bottom">
                            <strong>${item.libelle}</strong><br>${url}${coords}
                        </div>`;
                leftPanel.insertAdjacentHTML('beforeend', html);
            });
        }

        document.querySelectorAll('.btn-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                renderData(type);
            });
        });

        // --- Leaflet map (inchangé) ---
        const map = L.map('master-map').setView([46.8, 2.5], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = L.markerClusterGroup().addTo(map);
        const markerMap = {
            offres: {},
            entreprises: {},
            services: {}
        };

        function addMarkers(type) {
            const items = data[type] || [];
            items.forEach((item, idx) => {
                const lat = parseFloat(item.latitude);
                const lon = parseFloat(item.longitude);
                if (isNaN(lat) || isNaN(lon)) return;
                const popup =
                    `<strong>${item.libelle || 'Sans titre'}</strong><br>${item.url ? `<a href="${item.url}" target="_blank">Voir</a>` : ''}`;
                const marker = L.marker([lat, lon]).bindPopup(popup);
                markers.addLayer(marker);
                markerMap[type][idx] = marker;
            });
        }

        ['offres', 'entreprises', 'services'].forEach(addMarkers);
        if (markers.getLayers().length) map.fitBounds(markers.getBounds(), {
            padding: [30, 30]
        });
    });
</script>

<!-- ===== Styles ===== -->
<style>
    .card {
        border-radius: 10px;
    }

    .nav-link.active {
        font-weight: 600;
        color: #0d6efd !important;
        border-bottom: 2px solid #0d6efd;
    }

    .nav-link:hover {
        text-decoration: underline;
    }

    #master-map.inactive {
        filter: grayscale(70%) brightness(0.7);
        pointer-events: none;
    }
</style>