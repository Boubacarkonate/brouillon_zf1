<h1 class="mb-4">March√© du travail local</h1>

<!-- ======================= -->
<!-- Formulaire de recherche -->
<!-- ======================= -->
<form method="get" class="mb-4">
    <div class="row g-2">
        <div class="col-md-3">
            <select id="selectProjet" class="form-select shadow-sm">
                <option value="">-- Choisir un projet --</option>
                <?php foreach ($this->projet as $nom => $data): ?>
                    <option value="<?= htmlspecialchars(json_encode($data)) ?>">
                        <?= $this->escape($nom) ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <div class="col-md-2">
            <input type="text" name="territoireCode" id="territoireCode" class="form-control shadow-sm"
                placeholder="Code territoire (ex: 75)" value="<?= $this->escape($this->territoireCode) ?>">
        </div>
        <div class="col-md-2">
            <input type="text" name="codeRome" id="codeRome" class="form-control shadow-sm"
                placeholder="Code ROME (ex: M1607)" value="<?= $this->escape($this->codeRome) ?>">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Analyser</button>
        </div>
    </div>
</form>

<?php if (!empty($this->error)): ?>
    <div class="alert alert-danger">
        Erreur API : <?= $this->escape($this->error) ?>
    </div>
<?php else: ?>

    <div class="row row-cols-1 row-cols-md-3 g-4">

        <!-- Dynamique -->
        <?php if (!empty($this->dynamique)): ?>
            <div class="col">
                <div class="card h-100 shadow-sm text-center">
                    <div class="card-header bg-secondary text-white fw-bold">
                        üìà Dynamique de l‚Äôemploi
                    </div>
                    <div class="card-body">
                        <h5 class="card-title mb-2">
                            <?= $this->escape($this->dynamique['territoire'] ?? '-') ?>
                            (<?= $this->escape($this->dynamique['departement'] ?? '-') ?>)
                        </h5>
                        <p class="mb-2"><strong>P√©riode :</strong> <?= $this->escape($this->dynamique['periodeLib'] ?? '-') ?>
                        </p>
                        <div class="alert alert-info py-2">
                            <span class="badge bg-<?= $this->dynamique['badge'] ?? 'secondary' ?> fs-5 me-2">
                                <?= $this->escape($this->dynamique['valeur'] ?? '-') ?>
                            </span>
                            <?= $this->escape($this->dynamique['interpretation'] ?? '-') ?>
                        </div>
                        <p class="text-muted small mt-3">
                            Source : France Travail, <?= $this->escape($this->dynamique['periodeLib']) ?>
                        </p>

                    </div>
                    <div class="card-footer text-muted small">
                        derni√®res mise √† jour des donn√©es :
                        <?php
                        if (!empty($this->dynamique['datMaj'])) {
                            $date = new DateTime($this->dynamique['datMaj']);
                            echo $this->escape($date->format('d/m/Y')); // JJ/MM/AAAA
                        } else {
                            echo '-';
                        }
                        ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <!-- Indicateurs prioritaires -->
        <?php if (!empty($this->intensiteEmbauche) || !empty($this->manqueMainOeuvre || !empty($this->tensionPrincipale))): ?>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm text-center border-0">
                    <div class="card-header bg-secondary text-white fw-bold">
                        ‚≠ê Indicateurs prioritaires
                    </div>
                    <div class="card-body">
                        <?php if (!empty($this->intensiteEmbauche)): ?>
                            <p><strong>Intensit√© d‚Äôembauche :</strong>
                                <span class="badge bg-<?= $this->intensiteEmbauche['badge'] ?>">
                                    <?= $this->escape($this->intensiteEmbauche['texte']) ?>
                                </span>
                            </p>
                        <?php endif; ?>

                        <?php if (!empty($this->manqueMainOeuvre)): ?>
                            <p><strong>Manque de main d‚Äô≈ìuvre :</strong>
                                <span class="badge bg-<?= $this->manqueMainOeuvre['badge'] ?>">
                                    <?= $this->escape($this->manqueMainOeuvre['texte']) ?>
                                </span>
                            </p>
                            <p class="text-muted small mt-3">
                                Source : France Travail, <?= $this->escape($this->intensiteEmbauche['periodeLib']) ?>
                            </p>

                        <?php endif; ?>
                    </div>
                    <div class="card-footer text-muted small">
                        derni√®res mise √† jour des donn√©es :
                        <?php

                        $date = new DateTime($this->tensionPrincipale['datMaj']);
                        echo $this->escape($date->format('d/m/Y')); // JJ/MM/AAAA

                        ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <!-- Indicateurs secondaires -->
        <!-- <?php if (!empty($this->attractiviteSalariale) || !empty($this->conditionsTravail) || !empty($this->durabiliteEmploi) || !empty($this->inadEquationGeo)): ?>
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm text-center border-0">
            <div class="card-header bg-dark text-white fw-bold">
                ‚ö° Indicateurs secondaires
            </div>
            <div class="card-body">
                <?php foreach (['attractiviteSalariale', 'conditionsTravail', 'durabiliteEmploi', 'inadEquationGeo'] as $ind):
                        if (!empty($this->$ind)):
                ?>
                <p><strong><?= ucwords(str_replace('_', ' ', $ind)) ?> :</strong>
                    <span class="badge bg-<?= $this->$ind['badge'] ?>">
                        <?= $this->escape($this->$ind['texte']) ?>
                    </span>
                </p>
                <?php
                        endif;
                    endforeach; ?>
            </div>
        </div>
    </div>
    <?php endif; ?> -->


        <!-- Demandeurs -->
        <?php if (!empty($this->demandeur12DerniersMois)): ?>
            <div class="col">
                <div class="card h-100 shadow-sm text-center">
                    <div class="card-header bg-secondary text-white fw-bold">üë• Demandeurs d‚Äôemploi</div>
                    <div class="card-body">
                        <h2 class="fw-bold display-6 text-primary">
                            <?= number_format($this->demandeur12DerniersMois['nombre'], 0, ',', ' ') ?>
                        </h2>
                        <p class="mb-1 fs-5">demandeurs d'emploi</p>
                        <p class="text-muted mb-2">ont recherch√© ce m√©tier au cours des 12 derniers mois</p>
                        <p class="text-muted small mt-3">
                            Source : France Travail, <?= $this->escape($this->demandeur12DerniersMois['periodeLib']) ?>
                        </p>
                    </div>
                    <div class="card-footer text-muted small">
                        derni√®res mise √† jour des donn√©es :
                        <?php

                        $date = new DateTime($this->demandeur12DerniersMois['datMaj']);
                        echo $this->escape($date->format('d/m/Y')); // JJ/MM/AAAA

                        ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <!-- Embauches -->
        <?php if (!empty($this->embauches)): ?>
            <div class="col">
                <div class="card h-100 shadow-sm text-center">
                    <div class="card-header bg-secondary text-white fw-bold">üíº Embauches r√©centes</div>
                    <div class="card-body">
                        <h4 class="fw-bold text-success mb-3">
                            <?= number_format($this->embauches['nombre'], 0, ',', ' ') ?>
                        </h4>
                        <p>pour le m√©tier de <strong><?= $this->escape($this->embauches['activite']) ?></strong><br>
                            au cours du <strong><?= $this->escape($this->embauches['periodeLib']) ?></strong>.</p>
                        <p class="small text-muted mt-2">
                            Source : France Travail, <?= $this->escape($this->embauches['periodeLib']) ?>
                        </p>
                    </div>
                    <div class="card-footer text-muted small">
                        derni√®res mise √† jour des donn√©es :
                        <?php

                        $date = new DateTime($this->embauches['datMaj']);
                        echo $this->escape($date->format('d/m/Y')); // JJ/MM/AAAA
                        ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <!-- R√©partition des contrats -->
        <?php if (!empty($this->embauches['typeContrat'])): ?>
            <div class="col-12">
                <div class="card shadow-sm text-center">
                    <div class="card-header bg-secondary text-white fw-bold">üìÑ R√©partition des embauches du m√©tier</div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-3">
                            <?php foreach ($this->embauches['typeContrat'] as $contrat): ?>
                                <?php if (!empty($contrat['nombre']) && $contrat['nombre'] > 0): ?>
                                    <li><?= $this->escape($contrat['libCaract']) ?> (<?= $this->escape($contrat['pourcentage']) ?>%)
                                    </li>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </ul>
                        <p class="small text-muted mb-0">
                            Source : Acoss &amp; MSA, <?= $this->escape($this->embauches['periodeLib']) ?>
                        </p>
                    </div>
                    <div class="card-footer text-muted small">
                        derni√®res mise √† jour des donn√©es :
                        <?php

                        $date = new DateTime($this->embauches['datMaj']);
                        echo $this->escape($date->format('d/m/Y')); // JJ/MM/AAAA
                        ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <!-- Offres -->
        <?php if (!empty($this->statsOffres)): ?>
            <div class="col">
                <div class="card h-100 shadow-sm text-center">
                    <div class="card-header bg-secondary text-white fw-bold">üìä Offres d‚Äôemploi</div>
                    <div class="card-body">
                        <h2 class="fw-bold display-6 text-primary">
                            <?= number_format($this->statsOffres['nombre'], 0, ',', ' ') ?>
                        </h2>
                        <p class="mb-1 fs-5">offres d‚Äôemploi</p>
                        <p class="text-muted mb-2">d√©pos√©es par les employeurs et partenaires aupr√®s de France Travail</p>
                        <p class="small mb-0">au cours des 12 derniers mois pour ce m√©tier</p>
                        <p class="text-muted small mt-3">
                            Source : France Travail, <?= $this->escape($this->statsOffres['periodeLib']) ?>
                        </p>
                    </div>
                    <div class="card-footer text-muted small">
                        derni√®res mise √† jour des donn√©es :
                        <?php

                        $date = new DateTime($this->statsOffres['datMaj']);
                        echo $this->escape($date->format('d/m/Y')); // JJ/MM/AAAA
                        ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>

    </div> <!-- fin de la grille -->
<?php endif; ?>
<script>
    const selectProjet = document.getElementById('selectProjet');
    if (selectProjet) {
        selectProjet.addEventListener('change', function() {
            if (this.value) {
                try {
                    const data = JSON.parse(this.value);
                    if (data.coderome) document.getElementById('codeRome').value = data.coderome;
                    if (data.departement) document.getElementById('territoireCode').value = data.departement;
                } catch (e) {
                    console.error("Erreur JSON projet :", e);
                }
            }
        });
    }
</script>