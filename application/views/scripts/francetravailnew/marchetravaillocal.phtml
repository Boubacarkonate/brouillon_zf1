<h1>March√© du travail local</h1>

<!-- ======================= -->
<!-- Formulaire de recherche -->
<!-- ======================= -->
<form method="get" class="mb-4">
    <div class="row g-2">
        <div class="col-md-3">
            <select id="selectProjet" class="form-select shadow-sm">
                <option value="">-- Choisir un projet --</option>
                <?php foreach ($this->projet as $nom => $data): ?>
                    <option value="<?= htmlspecialchars(json_encode($data)) ?>">
                        <?= $this->escape($nom) ?>
                    </option>
                <?php endforeach; ?>
            </select>
            <!-- <div class="col-md-2">
            <select id="selectPeriode" name="periodeRecherchee" class="form-select shadow-sm">
                <option value="">-- Choisir une p√©riode --</option>
                <?php foreach ($this->periode as $nom): ?>
                    <option value="<?= htmlspecialchars($nom) ?>"
                        <?= ($nom === $this->periodeRecherchee ? 'selected' : '') ?>>
                        <?= $this->escape($nom) ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div> -->
        </div>
        <div class="col-md-2">
            <input type="text" name="territoireCode" id="territoireCode" class="form-control shadow-sm"
                placeholder="Code territoire (ex: 75)" value="<?= $this->escape($this->territoireCode) ?>">
        </div>
        <div class="col-md-2">
            <input type="text" name="codeRome" id="codeRome" class="form-control shadow-sm"
                placeholder="Code ROME (ex: M1607)" value="<?= $this->escape($this->codeRome) ?>">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Analyser</button>
        </div>
    </div>
</form>

<?php if (!empty($this->error)): ?>
    <div class="alert alert-danger">
        Erreur API : <?= $this->escape($this->error) ?>
    </div>
<?php else: ?>

    <!-- Bloc 1 : Contexte global -->
    <?php if (!empty($this->dynamique) || !empty($this->tension)): ?>
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-dark text-white">Contexte du march√© local</div>
            <div class="card-body">
                <?php if (!empty($this->dynamique)): ?>
                    <p><strong>Dynamique :</strong>
                        <?= $this->escape($this->dynamique['interpretation']) ?>
                        <span class="badge bg-<?= $this->dynamique['badge'] ?>">
                            <?= $this->escape($this->dynamique['valeur']) ?>
                        </span>
                    </p>
                <?php endif; ?>

                <?php if (!empty($this->tension)): ?>
                    <p><strong>Tension de recrutement :</strong>
                        <?= $this->escape($this->tension['interpretation']) ?>
                        (indice <?= $this->escape($this->tension['valeur']) ?>)
                    </p>
                <?php endif; ?>
            </div>
        </div>
    <?php endif; ?>

    <!-- ======================= -->
    <!-- R√©sum√© synth√©tique CIP -->
    <!-- ======================= -->
    <?php if (!empty($this->dynamique) || !empty($this->tension) || !empty($this->dernierDemandeurs) || !empty($this->dernieresEmbauches)): ?>
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-dark text-white">
                R√©sum√© march√© ‚Äî M√©tier <?= $this->escape($this->codeRome) ?>, Territoire
                <?= $this->escape($this->territoireCode) ?>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <?php if (!empty($this->dynamique)): ?>
                        <li>üìà <strong>Dynamique :</strong>
                            <?= $this->escape($this->dynamique['interpretation']) ?>
                        </li>
                    <?php endif; ?>

                    <?php if (!empty($this->tension)): ?>
                        <li>‚ö†Ô∏è <strong>Tension :</strong>
                            <?= $this->escape($this->tension['interpretation']) ?>
                        </li>
                    <?php endif; ?>

                    <?php if (!empty($this->dernierDemandeurs)): ?>
                        <li>üë• <strong>Demandeurs :</strong>
                            <?= number_format($this->dernierDemandeurs['nombre'], 0, ',', ' ') ?>
                            (<?= $this->escape($this->dernierDemandeurs['periodeLib']) ?>)
                        </li>
                    <?php endif; ?>

                    <?php if (!empty($this->dernieresEmbauches)): ?>
                        <li>üíº <strong>Embauches :</strong>
                            <?= number_format($this->dernieresEmbauches['nombre'], 0, ',', ' ') ?>
                            (<?= $this->escape($this->dernieresEmbauches['periodeLib']) ?>)
                        </li>
                    <?php endif; ?>
                </ul>
            </div>
        </div>
    <?php endif; ?>

    <!-- ======================= -->
    <!-- Dynamique de l'emploi   -->
    <!-- ======================= -->
    <?php if (!empty($this->dynamique)): ?>
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-primary text-white">üìà Dynamique de l‚Äôemploi</div>
            <div class="card-body">
                <p><strong>P√©riode :</strong> <?= $this->escape($this->dynamique['periode'] ?? 'Non disponible') ?></p>
                <p><strong>Activit√© :</strong> <?= $this->escape($this->dynamique['activite'] ?? 'Non disponible') ?></p>
                <div class="alert alert-info">
                    Indice :
                    <span class="badge bg-<?= $this->dynamique['badge'] ?? 'secondary' ?>">
                        <?= $this->escape($this->dynamique['valeur'] ?? '-') ?>
                    </span>
                    ‚Äî <?= $this->escape($this->dynamique['interpretation'] ?? 'Non disponible') ?>
                </div>
            </div>
        </div>
    <?php endif; ?>


    <!-- ======================= -->
    <!-- Tension recrutement     -->
    <!-- ======================= -->
    <?php if (!empty($this->tension)): ?>
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-danger text-white">‚ö†Ô∏è Tension de recrutement</div>
            <div class="card-body">
                <p><strong>M√©tier :</strong> <?= $this->escape($this->tension['libActivite']) ?></p>
                <p>
                    <strong>Indice tension :</strong>
                    <?= $this->escape($this->tension['valeur']) ?>
                    <span class="badge 
                        <?php if ($this->tension['valeur'] >= 1) echo 'bg-danger';
                        elseif ($this->tension['valeur'] > 0) echo 'bg-warning';
                        else echo 'bg-success'; ?>">
                        <?= $this->escape($this->tension['interpretation']) ?>
                    </span>
                </p>
            </div>
        </div>
    <?php endif; ?>

    <!-- ======================= -->
    <!-- Demandeurs d'emploi     -->

    <?php if (!empty($this->dernierDemandeurs)): ?>
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-primary text-white">Demandeurs d'emploi</div>
            <div class="card-body">
                <p><strong>M√©tier :</strong> <?= $this->escape($this->dernierDemandeurs['activite']) ?></p>

                <p><strong>Derni√®re p√©riode :</strong> <?= $this->escape($this->dernierDemandeurs['periodeLib']) ?></p>
                <p><strong>Nombre :</strong> <?= number_format($this->dernierDemandeurs['nombre'], 0, ',', ' ') ?></p>
                <p><strong>Part relative :</strong> <?= $this->escape($this->dernierDemandeurs['pourcentage']) ?>%</p>

                <?php if (!empty($this->dernierDemandeurs['caracteristiques'])): ?>
                    <ul>
                        <?php foreach ($this->dernierDemandeurs['caracteristiques'] as $c): ?>
                            <li><?= $this->escape($c['libCaract']) ?> :
                                <?= number_format($c['nombre'], 0, ',', ' ') ?> (<?= $c['pourcentage'] ?>%)
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
            </div>
        </div>
    <?php endif; ?>

    <!-- ======================= -->
    <!-- Embauches r√©centes      -->
    <!-- ======================= -->
    <?php if (!empty($this->dernieresEmbauches)): ?>
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-success text-white">üíº Embauches r√©centes</div>
            <div class="card-body">
                <p><strong>Nombre :</strong> <?= number_format($this->dernieresEmbauches['nombre'], 0, ',', ' ') ?></p>
                <p><strong>P√©riode :</strong> <?= $this->escape($this->dernieresEmbauches['periodeLib']) ?></p>
            </div>
        </div>
    <?php endif; ?>

    <!-- ======================= -->
    <!-- Salaire m√©dian          -->
    <!-- ======================= -->
    <?php if (!empty($this->salaireCaracteristiques)): ?>
        <!-- <?php var_dump($this->salaireCaracteristiques)  ?> -->
        <?php var_dump($this->salaireMedian)  ?>
        <table class="table table-sm mt-2">
            <thead>
                <tr>
                    <th>Caract√©ristique</th>
                    <th>Montant (‚Ç¨)</th>
                    <th>Taux (%)</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($this->salaireCaracteristiques as $c): ?>
                    <tr>
                        <td><?= $this->escape($c['libCaract']) ?></td>
                        <td><?= isset($c['montant']) ? number_format($c['montant'], 0, ',', ' ') : '-' ?></td>
                        <td><?= isset($c['taux']) ? $c['taux'] : '-' ?></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>




<?php endif; ?>

<!-- Script auto-remplissage projet -->
<script>
    const selectProjet = document.getElementById('selectProjet');
    if (selectProjet) {
        selectProjet.addEventListener('change', function() {
            if (this.value) {
                try {
                    const data = JSON.parse(this.value);
                    if (data.coderome) document.getElementById('codeRome').value = data.coderome;
                    if (data.departement) document.getElementById('territoireCode').value = data.departement;
                } catch (e) {
                    console.error("Erreur JSON projet :", e);
                }
            }
        });
    }
</script>