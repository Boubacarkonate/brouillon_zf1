<h1 class="mb-4 text-primary">üìä March√© du travail local</h1>

<!-- ======================= -->
<!-- Formulaire de recherche -->
<!-- ======================= -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label text-muted">Projet</label>
                <select id="selectProjet" class="form-select shadow-sm">
                    <option value="">-- Choisir un projet --</option>
                    <?php foreach ($this->projet as $nom => $data): ?>
                        <option value="<?= htmlspecialchars(json_encode($data)) ?>">
                            <?= $this->escape($nom) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted">Code territoire</label>
                <input type="text" name="territoireCode" id="territoireCode" class="form-control shadow-sm"
                    placeholder="Ex: 75" value="<?= $this->escape($this->territoireCode) ?>">
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted">Code ROME</label>
                <input type="text" name="codeRome" id="codeRome" class="form-control shadow-sm" placeholder="Ex: M1607"
                    value="<?= $this->escape($this->codeRome) ?>">
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-secondary shadow-sm">
                    <i class="bi bi-graph-up"></i> Analyser
                </button>
            </div>
        </form>
    </div>
</div>

<?php if (!empty($this->error)): ?>
    <div class="alert alert-danger">
        Erreur API : <?= $this->escape($this->error) ?>
    </div>
<?php else: ?>

    <!-- ======================= -->
    <!-- R√©sum√© march√© -->
    <!-- ======================= -->
    <!-- R√©sum√© march√© avec bouton export -->
    <div class="col-md-12 mt-3">
        <a href="http://localhost/zf1/public/exportcsv.php" class="btn btn-outline-primary">
            <i class="bi bi-download"></i> Export CSV
        </a>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            R√©sum√© march√© ‚Äî M√©tier <?= $this->escape($this->codeRome) ?>, Territoire
            <?= $this->escape($this->territoireCode) ?>
            <button id="exportCsvBtn" class="btn btn-sm btn-outline-light">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
        <div class="card-body row g-3">
            <?php if (!empty($this->dynamique)): ?>
                <div class="col-md-3">
                    <div class="badge bg-primary w-100 fs-6 p-3">üìà Dynamique :
                        <?= $this->escape($this->dynamique['interpretation']) ?>
                    </div>
                </div>
            <?php endif; ?>
            <?php if (!empty($this->tensionPrincipale)): ?>
                <div class="col-md-3">
                    <div class="badge bg-warning text-dark w-100 fs-6 p-3">‚ö†Ô∏è Tension :
                        <?= $this->escape($this->tensionPrincipale['valeur']) ?>
                    </div>
                </div>
            <?php endif; ?>
            <?php if (!empty($this->dernierDemandeurs)): ?>
                <div class="col-md-3">
                    <div class="badge bg-info w-100 fs-6 p-3">üë• Demandeurs :
                        <?= number_format($this->dernierDemandeurs['nombre'], 0, ',', ' ') ?>
                    </div>
                </div>
            <?php endif; ?>
            <?php if (!empty($this->embauches)): ?>
                <div class="col-md-3">
                    <div class="badge bg-success w-100 fs-6 p-3">üíº Embauches :
                        <?= number_format($this->embauches['nombre'], 0, ',', ' ') ?>
                    </div>
                </div>
            <?php endif; ?>
        </div>
    </div>

    <!-- ======================= -->
    <!-- Dynamique emploi -->
    <!-- ======================= -->
    <?php if (!empty($this->dynamique)): ?>
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">üìà Dynamique de l‚Äôemploi</div>
            <div class="card-body">
                <p><strong>P√©riode :</strong> <?= $this->escape($this->dynamique['periodeLib'] ?? '-') ?></p>
                <p><strong>Activit√© :</strong> <?= $this->escape($this->dynamique['activite'] ?? '-') ?></p>
                <p><strong>Lieu :</strong> <?= $this->escape($this->dynamique['territoire'] ?? '-') ?>
                    (<?= $this->escape($this->dynamique['departement'] ?? '-') ?>)</p>
                <div class="alert alert-info mt-3">
                    Indice : <span
                        class="badge bg-<?= $this->dynamique['badge'] ?? 'secondary' ?>"><?= $this->escape($this->dynamique['valeur']) ?></span>
                    ‚Äî <?= $this->escape($this->dynamique['interpretation']) ?>
                </div>
            </div>
        </div>
    <?php endif; ?>

    <!-- ======================= -->
    <!-- Dashboard Onglets -->
    <!-- ======================= -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="indicateurs-tab" data-bs-toggle="tab" data-bs-target="#indicateurs"
                        type="button" role="tab">üìä Indicateurs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="embauches-tab" data-bs-toggle="tab" data-bs-target="#embauches"
                        type="button" role="tab">üíº Embauches</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="salaire-tab" data-bs-toggle="tab" data-bs-target="#salaire" type="button"
                        role="tab">üí∞ Salaire</button>
                </li>
            </ul>
        </div>
        <div class="card-body tab-content">
            <!-- Indicateurs -->
            <div class="tab-pane fade show active" id="indicateurs" role="tabpanel">
                <div class="row g-3">
                    <?php if (!empty($this->intensiteEmbauche)): ?>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <strong>Intensit√© embauche :</strong><br>
                                <?= $this->escape($this->intensiteEmbauche['valeur']) ?> ‚Äî
                                <?= $this->escape($this->intensiteEmbauche['interpretation']) ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    <?php if (!empty($this->manqueMainOeuvre)): ?>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <strong>Manque de main d‚Äô≈ìuvre :</strong><br>
                                <?= $this->escape($this->manqueMainOeuvre['valeur']) ?> ‚Äî
                                <?= $this->escape($this->manqueMainOeuvre['interpretation']) ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    <?php if (!empty($this->attractiviteSalariale)): ?>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <strong>Attractivit√© salariale :</strong><br>
                                <?= $this->escape($this->attractiviteSalariale['valeur']) ?> ‚Äî
                                <?= $this->escape($this->attractiviteSalariale['interpretation']) ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    <?php if (!empty($this->conditionsTravail)): ?>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <strong>Conditions de travail :</strong><br>
                                <?= $this->escape($this->conditionsTravail['valeur']) ?> ‚Äî
                                <?= $this->escape($this->conditionsTravail['interpretation']) ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    <?php if (!empty($this->durabiliteEmploi)): ?>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <strong>Durabilit√© emploi :</strong><br>
                                <?= $this->escape($this->durabiliteEmploi['valeur']) ?> ‚Äî
                                <?= $this->escape($this->durabiliteEmploi['interpretation']) ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    <?php if (!empty($this->inadEquationGeo)): ?>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <strong>Inad√©quation g√©ographique :</strong><br>
                                <?= $this->escape($this->inadEquationGeo['valeur']) ?> ‚Äî
                                <?= $this->escape($this->inadEquationGeo['interpretation']) ?>
                            </div>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Embauches -->
            <div class="tab-pane fade" id="embauches" role="tabpanel">
                <?php if (!empty($this->embauches)): ?>
                    <p>Au <?= $this->escape($this->embauches['periodeLib']) ?>, dans le d√©partement
                        <?= $this->escape($this->embauches['departement']) ?>, il y a eu
                        <strong><?= number_format($this->embauches['nombre'], 0, ',', ' ') ?></strong> embauches pour le m√©tier
                        de
                        <?= $this->escape($this->embauches['activite']) ?>.
                    </p>
                    <?php if (!empty($this->embauches['typeContrat'])): ?>
                        <h6 class="mt-3">R√©partition par type de contrat :</h6>
                        <div class="row">
                            <?php foreach ($this->embauches['typeContrat'] as $contrat): ?>
                                <div class="col-md-4">
                                    <div class="p-2 bg-light rounded border mb-2">
                                        <?= $this->escape($contrat['libCaract']) ?> :
                                        <?= number_format($contrat['nombre'], 0, ',', ' ') ?>
                                        (<?= $contrat['pourcentage'] ?>%)
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                <?php else: ?>
                    <p>Aucune donn√©e d‚Äôembauche disponible.</p>
                <?php endif; ?>
            </div>

            <!-- Salaire -->
            <div class="tab-pane fade" id="salaire" role="tabpanel">
                <?php if (!empty($this->salaireParRome)) : ?>
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>M√©tier</th>
                                <th>P√©riode</th>
                                <th>D√©butant</th>
                                <th>Moyen</th>
                                <th>Exp√©riment√©</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($this->salaireParRome as $s) : ?>
                                <tr>
                                    <td><?= $this->escape($s['activite']) ?></td>
                                    <td><?= $this->escape($s['periode']) ?></td>
                                    <td><?= $s['salaire1'] ? number_format($s['salaire1'], 0, ',', ' ') . ' ‚Ç¨' : '-' ?></td>
                                    <td><?= $s['salaire2'] ? number_format($s['salaire2'], 0, ',', ' ') . ' ‚Ç¨' : '-' ?></td>
                                    <td><?= $s['salaire3'] ? number_format($s['salaire3'], 0, ',', ' ') . ' ‚Ç¨' : '-' ?></td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                <?php else: ?>
                    <p>Aucune donn√©e salariale disponible.</p>
                <?php endif; ?>
            </div>
        </div>
    </div>

<?php endif; ?>

<!-- ======================= -->
<!-- Script auto-remplissage projet -->
<!-- ======================= -->
<script>
    const selectProjet = document.getElementById('selectProjet');
    if (selectProjet) {
        selectProjet.addEventListener('change', function() {
            if (this.value) {
                try {
                    const data = JSON.parse(this.value);
                    if (data.coderome) document.getElementById('codeRome').value = data.coderome;
                    if (data.departement) document.getElementById('territoireCode').value = data.departement;
                } catch (e) {
                    console.error("Erreur JSON projet :", e);
                }
            }
        });
    }

    document.getElementById('exportCsvBtn')?.addEventListener('click', function() {
        const rows = [];
        rows.push(['Indicateur', 'Valeur', 'Interpr√©tation']);

        <?php if (!empty($this->dynamique)): ?>
            rows.push(['Dynamique', '<?= $this->escape($this->dynamique['valeur'] ?? '-') ?>',
                '<?= $this->escape($this->dynamique['interpretation'] ?? '-') ?>'
            ]);
        <?php endif; ?>
        <?php if (!empty($this->tension)): ?>
            rows.push(['Tension', '<?= $this->escape($this->tension['valeur'] ?? '-') ?>',
                '<?= $this->escape($this->tension['interpretation'] ?? '-') ?>'
            ]);
        <?php endif; ?>
        <?php if (!empty($this->dernierDemandeurs)): ?>
            rows.push(['Demandeurs', '<?= number_format($this->dernierDemandeurs['nombre'], 0, ',', ' ') ?>', '-']);
        <?php endif; ?>
        <?php if (!empty($this->dernieresEmbauches)): ?>
            rows.push(['Embauches', '<?= number_format($this->dernieresEmbauches['nombre'], 0, ',', ' ') ?>', '-']);
        <?php endif; ?>

        // Cr√©er le CSV
        let csvContent = "data:text/csv;charset=utf-8," +
            rows.map(e => e.join(";")).join("\n");

        // Encoder URI et d√©clencher t√©l√©chargement
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "resume_marche_travail.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
</script>